{
  "title": "Star Wars â€” Observe & Block (Tetragon)",
  "uid": "starwars-observe-block-v12",
  "tags": ["tetragon","starwars","demo"],
  "schemaVersion": 39,
  "version": 1,
  "editable": true,
  "refresh": "10s",
  "time": { "from": "now-30m", "to": "now" },
  "templating": {
    "list": [
      {
        "name": "DS_PROM",
        "type": "datasource",
        "label": "Prometheus DS",
        "query": "prometheus",
        "current": {},
        "refresh": 1
      },
      {
        "name": "namespace",
        "type": "constant",
        "label": "Namespace",
        "query": "tetragon-demo",
        "current": { "text": "tetragon-demo", "value": "tetragon-demo" }
      },
      {
        "name": "alliance_workload",
        "type": "constant",
        "label": "Alliance workload",
        "query": "xwing",
        "current": { "text": "xwing", "value": "xwing" }
      },
      {
        "name": "empire_workload",
        "type": "constant",
        "label": "Empire workload",
        "query": "tiefighter",
        "current": { "text": "tiefighter", "value": "tiefighter" }
      },
      {
        "name": "job_label",
        "type": "constant",
        "label": "Prom job label value",
        "query": "tetragon",
        "current": { "text": "tetragon", "value": "tetragon" }
      }
    ]
  },
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "type": "dashboard",
        "name": "Annotations & Alerts",
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "datasource": { "type": "grafana", "uid": "-- Grafana --" }
      }
    ]
  },
  "panels": [
    {
      "type": "stat",
      "title": "Blocks/min (SIGKILL)",
      "gridPos": { "h": 6, "w": 6, "x": 0, "y": 0 },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false },
        "orientation": "auto",
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto"
      },
      "targets": [
        {
          "refId": "A",
          "datasource": { "type": "prometheus", "uid": "${DS_PROM}" },
          "editorMode": "code",
          "expr": "sum(rate(tetragon_events_total{job=\"$job_label\",namespace=\"$namespace\",type=\"PROCESS_EXIT\",exit=\"SIGKILL\"}[$__rate_interval]))",
          "legendFormat": "blocks/min"
        }
      ]
    },
    {
      "type": "stat",
      "title": "Attempts/min (curl exec)",
      "gridPos": { "h": 6, "w": 6, "x": 6, "y": 0 },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false },
        "orientation": "auto",
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto"
      },
      "targets": [
        {
          "refId": "A",
          "datasource": { "type": "prometheus", "uid": "${DS_PROM}" },
          "editorMode": "code",
          "expr": "sum(rate(tetragon_events_total{job=\"$job_label\",namespace=\"$namespace\",type=\"PROCESS_EXEC\",binary=~\".*curl.*\"}[$__rate_interval]))",
          "legendFormat": "attempts/min"
        }
      ]
    },
    {
      "type": "stat",
      "title": "Connect kprobes/min (observe)",
      "description": "All kprobe events (good proxy for __arm64_sys_connect/tcp_v4_connect activity)",
      "gridPos": { "h": 6, "w": 6, "x": 12, "y": 0 },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false },
        "orientation": "auto",
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto"
      },
      "targets": [
        {
          "refId": "A",
          "datasource": { "type": "prometheus", "uid": "${DS_PROM}" },
          "editorMode": "code",
          "expr": "sum(rate(tetragon_events_total{job=\"$job_label\",namespace=\"$namespace\",type=\"PROCESS_KPROBE\"}[$__rate_interval]))",
          "legendFormat": "kprobes/min"
        }
      ]
    },
    {
      "type": "stat",
      "title": "Alliance blocks/min (xwing)",
      "gridPos": { "h": 6, "w": 6, "x": 18, "y": 0 },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false },
        "orientation": "auto",
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto"
      },
      "targets": [
        {
          "refId": "A",
          "datasource": { "type": "prometheus", "uid": "${DS_PROM}" },
          "editorMode": "code",
          "expr": "sum(rate(tetragon_events_total{job=\"$job_label\",namespace=\"$namespace\",type=\"PROCESS_EXIT\",exit=\"SIGKILL\",workload=\"$alliance_workload\"}[$__rate_interval]))",
          "legendFormat": "xwing blocks/min"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Attempts vs Blocks by workload",
      "gridPos": { "h": 12, "w": 24, "x": 0, "y": 6 },
      "fieldConfig": { "defaults": { "custom": { "drawStyle": "line", "lineWidth": 2, "spanNulls": true } }, "overrides": [] },
      "options": {
        "legend": { "displayMode": "table", "placement": "bottom", "calcs": ["lastNotNull"] },
        "tooltip": { "mode": "single", "sort": "none" }
      },
      "targets": [
        {
          "refId": "A",
          "datasource": { "type": "prometheus", "uid": "${DS_PROM}" },
          "editorMode": "code",
          "expr": "sum by (workload)(rate(tetragon_events_total{job=\"$job_label\",namespace=\"$namespace\",type=\"PROCESS_EXEC\",binary=~\".*curl.*\",workload=~\"$alliance_workload|$empire_workload\"}[$__rate_interval]))",
          "legendFormat": "attempts ({{workload}})"
        },
        {
          "refId": "B",
          "datasource": { "type": "prometheus", "uid": "${DS_PROM}" },
          "editorMode": "code",
          "expr": "sum by (workload)(rate(tetragon_events_total{job=\"$job_label\",namespace=\"$namespace\",type=\"PROCESS_EXIT\",exit=\"SIGKILL\",workload=~\"$alliance_workload|$empire_workload\"}[$__rate_interval]))",
          "legendFormat": "blocks ({{workload}})"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Kprobe activity by workload (observe)",
      "gridPos": { "h": 10, "w": 24, "x": 0, "y": 18 },
      "fieldConfig": { "defaults": { "custom": { "drawStyle": "line", "lineWidth": 1, "spanNulls": true } }, "overrides": [] },
      "options": {
        "legend": { "displayMode": "list", "placement": "bottom" },
        "tooltip": { "mode": "single", "sort": "none" }
      },
      "targets": [
        {
          "refId": "A",
          "datasource": { "type": "prometheus", "uid": "${DS_PROM}" },
          "editorMode": "code",
          "expr": "sum by (workload)(rate(tetragon_events_total{job=\"$job_label\",namespace=\"$namespace\",type=\"PROCESS_KPROBE\",workload=~\"$alliance_workload|$empire_workload\"}[$__rate_interval]))",
          "legendFormat": "kprobes ({{workload}})"
        }
      ]
    }
  ]
}